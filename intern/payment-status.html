<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Status — Internadda</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../style.css"> <style>
        .status-container {
            max-width: 600px;
            margin: 60px auto;
            padding: 40px;
            background: #fff;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
        }
        .status-icon {
            font-size: 4rem;
            margin-bottom: 25px;
        }
        .status-icon .fa-check-circle { color: var(--success); }
        .status-icon .fa-times-circle { color: #c53030; } /* Red for failure */
        .status-icon .fa-spinner { color: var(--primary); animation: spin 1s linear infinite; }
        .status-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 15px;
        }
        .status-message {
            font-size: 1.1rem;
            color: var(--gray);
            margin-bottom: 30px;
            line-height: 1.7;
        }
        .status-actions button, .status-actions a {
            margin: 10px;
        }
        .hidden { display: none !important; } /* Ensure hidden class works */

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-container">
            <a href="../index.html" class="logo">
              <img src="../images/logo.jpg" alt="InternAdda Logo" class="logo-img">
              <span class="logo-text">InternAdda</span>
            </a>
            <nav class="nav-menu">
                <a href="../index.html" class="nav-link">Home</a>
                <a href="../courses/course.html" class="nav-link">Courses</a>
                <a href="internship.html" class="nav-link">Internships</a>
                <a href="../jobs.html" class="nav-link">Jobs</a>
                <a href="../about.html" class="nav-link">About</a>
            </nav>
            </div>
    </header>

    <main>
        <div class="status-container">
            <div id="loading-state">
                <div class="status-icon"><i class="fas fa-spinner"></i></div>
                <h2 class="status-title">Checking Payment Status...</h2>
                <p class="status-message">Please wait while we verify your payment with Cashfree. Do not refresh this page.</p>
            </div>

            <div id="success-state" class="hidden">
                <div class="status-icon"><i class="fas fa-check-circle"></i></div>
                <h2 class="status-title">Payment Successful!</h2>
                <p class="status-message">Your payment has been confirmed. Redirecting you to the exam instructions shortly...</p>
                <div class="status-actions">
                    <a href="data_science_final_exam.html#instructions-step" id="proceed-btn" class="btn btn-primary btn-lg">Proceed to Exam Instructions</a>
                    </div>
            </div>

            <div id="failed-state" class="hidden">
                <div class="status-icon"><i class="fas fa-times-circle"></i></div>
                <h2 class="status-title">Payment Failed or Pending</h2>
                <p class="status-message">Unfortunately, we couldn't confirm your payment, or it might still be processing. Please check with your bank or UPI app. You can retry the payment if it failed.</p>
                 <p class="status-message" style="font-size: 0.9em;">Order ID: <span id="failed-order-id">N/A</span></p>
                <div class="status-actions">
                     <a href="data_science_final_exam.html" class="btn btn-primary">Retry Payment</a>
                    <a href="../index.html" class="btn btn-outline">Go to Homepage</a>
                </div>
            </div>

            <div id="error-state" class="hidden">
                <div class="status-icon"><i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i></div>
                <h2 class="status-title">Verification Error</h2>
                <p class="status-message">We encountered an issue while trying to verify your payment status. Please contact support if this problem persists.</p>
                <p class="status-message" style="font-size: 0.9em;">Order ID: <span id="error-order-id">N/A</span></p>
                <div class="status-actions">
                    <a href="../contact.html" class="btn btn-outline">Contact Support</a>
                     <a href="../index.html" class="btn btn-outline">Go to Homepage</a>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
             <div class="footer-bottom">
                <p>© 2025 Internadda. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loadingState = document.getElementById('loading-state');
            const successState = document.getElementById('success-state');
            const failedState = document.getElementById('failed-state');
            const errorState = document.getElementById('error-state');
            const proceedBtn = document.getElementById('proceed-btn');
            const failedOrderIdEl = document.getElementById('failed-order-id');
            const errorOrderIdEl = document.getElementById('error-order-id');

            // 1. Get Order ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('order_id'); // Matches the {order_id} in return_url

            if (!orderId) {
                console.error("Order ID not found in URL.");
                showState('error', 'Order ID missing in the return URL.');
                return;
            }

            if(failedOrderIdEl) failedOrderIdEl.textContent = orderId;
            if(errorOrderIdEl) errorOrderIdEl.textContent = orderId;

            // 2. Call Backend API to Check Status
            checkPaymentStatus(orderId);

            async function checkPaymentStatus(orderIdToCheck) {
                console.log(`Checking status for Order ID: ${orderIdToCheck}`);
                showState('loading');

                try {
                    // --- ACTUAL API Call to your Vercel function ---
                    console.log(`Fetching status from: /api/check-payment-status?orderId=${orderIdToCheck}`);
                    const response = await fetch(`/api/check-payment-status?orderId=${encodeURIComponent(orderIdToCheck)}`);
                    console.log("Status check response status code:", response.status);

                    if (!response.ok) {
                        // Handle server errors or 'Not Found' status from the API
                        if (response.status === 404) {
                             console.warn(`Payment record not found via API for ${orderIdToCheck}. Treating as PENDING/FAILED.`);
                             showState('failed'); // Show failed state if record doesn't exist yet
                        } else {
                            const errorData = await response.json().catch(() => ({})); // Try to get error details
                            throw new Error(`Server responded with status ${response.status}. ${errorData.error || ''}`);
                        }
                    } else {
                        const result = await response.json();
                        const paymentStatus = result.status; // e.g., "SUCCESS", "FAILED", "PENDING"
                        console.log(`Received Status via API for ${orderIdToCheck}: ${paymentStatus}`);

                        // 3. Update UI Based on Status received from API
                        if (paymentStatus === "SUCCESS") {
                            showState('success');
                            // Auto-redirect after a delay
                            setTimeout(() => {
                                // Redirect specifically to the instructions step fragment
                                window.location.href = `data_science_final_exam.html#instructions-step`;
                            }, 3000); // 3-second delay
                        } else {
                            // Treat PENDING, FAILED, or any other non-SUCCESS status as failure for the user on this page
                            console.log(`Payment status is ${paymentStatus}. Showing failed state.`);
                            showState('failed');
                        }
                    }
                } catch (error) {
                    console.error("Error calling checkPaymentStatus API or processing response:", error);
                    showState('error', `Could not verify payment status. Please try refreshing or contact support. Error: ${error.message}`);
                }
            }

            function showState(state, message = '') {
                // Hide all state divs first
                if(loadingState) loadingState.classList.add('hidden');
                if(successState) successState.classList.add('hidden');
                if(failedState) failedState.classList.add('hidden');
                if(errorState) errorState.classList.add('hidden');

                // Find and show the target state div
                const targetState = document.getElementById(`${state}-state`);
                if (targetState) {
                    targetState.classList.remove('hidden');
                    // Update error message if provided
                    if (message && state === 'error') {
                        const msgElement = targetState.querySelector('.status-message');
                        if (msgElement) msgElement.textContent = message;
                    }
                     // Ensure Order ID is displayed in error/failed states
                     if (state === 'failed' && failedOrderIdEl) failedOrderIdEl.textContent = orderId || 'N/A';
                     if (state === 'error' && errorOrderIdEl) errorOrderIdEl.textContent = orderId || 'N/A';

                } else {
                    console.error(`Error: State element #${state}-state not found in the HTML.`);
                    // Fallback: show error state if target state is missing
                     if (errorState) {
                        errorState.classList.remove('hidden');
                         const msgElement = errorState.querySelector('.status-message');
                         if (msgElement) msgElement.textContent = `An unexpected error occurred (UI state '${state}' not found). Please contact support.`;
                          if (errorOrderIdEl) errorOrderIdEl.textContent = orderId || 'N/A';
                     }
                }
            }

            // Ensure the proceed button targets the correct fragment identifier
            if (proceedBtn) {
                 proceedBtn.href = `data_science_final_exam.html#instructions-step`;
            }

        });
    </script>

</body>
</html>